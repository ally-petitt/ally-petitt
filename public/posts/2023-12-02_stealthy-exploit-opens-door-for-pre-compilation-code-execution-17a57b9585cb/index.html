<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/ally-petitt/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=ally-petitt/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Stealthy Exploit Opens Door for Pre-Compilation Code Execution | Ally Petitt</title>
<meta name="keywords" content="Autoconf, Linux, Informative">
<meta name="description" content="https://img.rasset.ie/001babea-1600.jpg
Introduction Linux users often take pride in their ability to compile their own code. In spite of this, a subtle yet critical attack vector has existed for over 20 years with high potential impact when exploited. Cleverly disguised within the configure.ac file, this attack vector allows malicious actors to execute code on your system before the compilation process even begins.
While the absence of known exploits may lull users into a false sense of security, it is precisely this lack of awareness that makes this attack vector dangerous, increasing the chances of successful and large-scale exploitation.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/ally-petitt/posts/2023-12-02_stealthy-exploit-opens-door-for-pre-compilation-code-execution-17a57b9585cb/">
<link crossorigin="anonymous" href="/ally-petitt/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/ally-petitt/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/ally-petitt/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/ally-petitt/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/ally-petitt/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/ally-petitt/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/ally-petitt/posts/2023-12-02_stealthy-exploit-opens-door-for-pre-compilation-code-execution-17a57b9585cb/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/ally-petitt/" accesskey="h" title="Ally Petitt (Alt + H)">Ally Petitt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Stealthy Exploit Opens Door for Pre-Compilation Code Execution
    </h1>
    <div class="post-meta"><span title='2023-12-02 00:00:00 +0000 UTC'>December 2, 2023</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#what-is-autoconf" aria-label="What is Autoconf?">What is Autoconf?</a></li>
                <li>
                    <a href="#how-does-autoconfwork" aria-label="How Does Autoconf Work?">How Does Autoconf Work?</a></li>
                <li>
                    <a href="#the-securityconcern" aria-label="The Security Concern">The Security Concern</a></li>
                <li>
                    <a href="#how-hard-was-this-tofind" aria-label="How Hard Was This To Find?">How Hard Was This To Find?</a></li>
                <li>
                    <a href="#autoconfs-response" aria-label="Autoconf’s Response">Autoconf’s Response</a></li>
                <li>
                    <a href="#implications" aria-label="Implications">Implications</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*XwuUEqGz-1xT_v_j.jpg" alt=""  />

<em><a href="https://img.rasset.ie/001babea-1600.jpg">https://img.rasset.ie/001babea-1600.jpg</a></em></p>
<h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>Linux users often take pride in their ability to compile their own code. In spite of this, a subtle yet critical attack vector has existed for over 20 years with high potential impact when exploited. Cleverly disguised within the <code>configure.ac</code> file, this attack vector allows malicious actors to execute code on your system before the compilation process even begins.</p>
<p>While the absence of known exploits may lull users into a false sense of security, it is precisely this lack of awareness that makes this attack vector dangerous, increasing the chances of successful and large-scale exploitation.</p>
<p>The security concern that I am referring to is the ability to execute arbitrary code through <code>autoconf</code>.</p>
<h1 id="what-is-autoconf">What is Autoconf?<a hidden class="anchor" aria-hidden="true" href="#what-is-autoconf">#</a></h1>
<p>Traditionally, developers have used a <a href="https://www.gnu.org/software/automake/manual/html_node/GNU-Build-System.html">build system</a> in order to distribute software packages that are easy for clients to compile. These build steps are specified in a Makefile.</p>
<p>Different systems have different requirements. Sometimes, they require different flags to be set during compilation and sometimes the compiler is referred to by a different name. With such a diverse array of systems and configurations to cater to, Autoconf was offered as a solution.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*WhDuZ1uRN5oHHeR9" alt=""  />

<em>GNU Logo</em></p>
<p>Autoconf is a crucial part of the GNU Autotools project and it ensures that packages are portable across different systems. It accomplishes this through macros from the M4 programming language to create a shell script that configures software source code packages for the respective system (see the <a href="https://github.com/autotools-mirror/autoconf">README</a> for more information).</p>
<h1 id="how-does-autoconfwork">How Does Autoconf Work?<a hidden class="anchor" aria-hidden="true" href="#how-does-autoconfwork">#</a></h1>
<p>Autoconf is one of the first commands executed when building a package that follows <a href="https://www.gnu.org/prep/standards/standards.html">GNU Coding Standards</a> (which is a lot of packages). If not called directly, it is often included in an <code>autogen.sh</code> script. The program uses instructions from a <code>configure.ac</code> file to generate a dynamic <code>configure</code>bash script that is responsible for matching the libraries on the system to those required in the program.</p>
<h1 id="the-securityconcern">The Security Concern<a hidden class="anchor" aria-hidden="true" href="#the-securityconcern">#</a></h1>
<p>Because Autoconf interprets user-controlled input through the <code>configure.ac</code> file, it is possible to insert malicious code that gets executed upon the running the generated <code>configure</code> file.</p>
<p>Furthermore, and increasingly concerning, is the possibility of obtaining code execution upon execution of the <code>autoconf</code> command- before the generated <code>configure</code> file is even ran. This means one less step in order to pwn a computer.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*Hgtdvi95rRshZbBM.png" alt=""  />

For example, hackers can embed a malicious payload within the <code>configure.ac</code> file and when an unsuspecting Linux user begins building the package, the attacker-controlled code would be executed on the system.</p>
<p>This can be abused to perform targeted cyberattacks on developers, general Linux users, security researchers, and more if the supply chain is compromised. Additionally, because this is not well-known, modern code-scanning and SAST solutions often fail to include checks for malicious code within <code>configure.ac</code>, decreasing the chance of detection.</p>
<p>I discuss exactly how to exploit this in my <a href="https://github.com/ally-petitt/autoconf-code-execution">Proof-of-Concept</a> on GitHub, which was published after receiving permission from the Autoconf maintainers to publicly disclose my concerns.</p>
<h1 id="how-hard-was-this-tofind">How Hard Was This To Find?<a hidden class="anchor" aria-hidden="true" href="#how-hard-was-this-tofind">#</a></h1>
<p>I want to briefly explain the ease with which I was able to uncover this potentially dangerous functionality. First, I identified the programming language being used was M4, so I read <a href="https://mbreen.com/m4.html">core notes</a> for approximately 30 minutes to get a high-level overview of the language.</p>
<p>After experimenting with the functionality and realizing that it was possible to embed bash code in the created <code>configure</code> script, I wondered if I could take it a step further and get code execution from running <code>autoconf</code> alone.</p>
<p>Within 2 hours of combing through the source code to learn how the application works, I identified 3 potential locations for code to be executed. I then created a <a href="https://github.com/ally-petitt/autoconf-code-execution">PoC</a> to submit in a bug report to the Autoconf maintainers.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/0*H4i_I34WTV0KbZE5" alt=""  />

<em><a href="https://seeklogo.com/images/M/m4-logo-88B85DB5FB-seeklogo.com.png">https://seeklogo.com/images/M/m4-logo-88B85DB5FB-seeklogo.com.png</a></em></p>
<p>My findings were low-hanging fruits and I suspect they have only gone this long without being abused because of the learning curve to understand M4. As you will see in the next segment, I am far from the first to know of this functionality.</p>
<h1 id="autoconfs-response">Autoconf’s Response<a hidden class="anchor" aria-hidden="true" href="#autoconfs-response">#</a></h1>
<p>Since 2/3 of my concerns came from a segment of legacy code that has been unused since the year 2000, one of the maintainers removed the macro in <a href="https://git.savannah.gnu.org/cgit/autoconf.git/commit/?id=11d8824daada20055c855f46ad7c45237c1ff455">this commit</a> and thanked me for bringing the unused code snippets to their attention.</p>
<p>They explained to me that there were plenty of opportunities to execute code when using Autoconf and that the ability to invoke macros such as <code>m4_syscmd</code>, allowing for code execution, was a conscious design decision as many of their users rely on that functionality. In fact, it is common for <code>m4_syscmd</code> to be used to run commands such as <code>git describe</code>.</p>
<p>Another of the points in my PoC was that they included a macro that executed the <code>cat</code> command without an absolute path. This made the program vulnerable to the modification of a $PATH environmental variable which could lead to execute arbitrary code execution and privilege escalation under the correct circumstances.</p>
<p>The maintainers explained that adding an absolute path to the binary would break Nix, Guix, and more. They made the assumption that Autoconf is being run in an environment with a secure $PATH within a sandbox, which is consistent with best practices. However, I have strong doubts that the majority of users actually follow these precautions.</p>
<h1 id="implications">Implications<a hidden class="anchor" aria-hidden="true" href="#implications">#</a></h1>
<p>I want to be clear that I respect the maintainers and the effort and time they have put into creating a tool that we have all benefited from. The ability to execute OS commands is not inherently dangerous, but when abused it can certainly have security implications.</p>
<p>Given the reliance on <code>m4_syscmd</code> by Autoconf’s clientele, it is clear to me that the maintainers have no plans of removing the functionality. The ability to execute arbitrary code upon running <code>autoconf</code> will remain in the foreseeable future, making it an even more attractive attack vector for adversaries.</p>
<p>In fact, the manner in which this functionality is built-in is reminiscent of attack techniques displayed in <a href="https://gtfobins.github.io/">GTFObins</a>, which are often used for privilege escalation.</p>
<h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>The ability to run commands from Autoconf is a feature, not a bug. However, it is a feature that can be abused in a way that very few people are aware of. And when exploited strategically, this can lead to the infection or damage of thousands of devices.</p>
<p>I hope that in writing this, I was able to bring awareness to open-source users on the potential dangers of configuring untrusted applications. If you have any questions, concerns, or criticisms on this article, feel free to message me on <a href="https://www.linkedin.com/in/ally-petitt/">LinkedIn</a> and I will be happy to discuss them with you.</p>
<p>Thanks for reading!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/ally-petitt/tags/autoconf/">Autoconf</a></li>
      <li><a href="http://localhost:1313/ally-petitt/tags/linux/">Linux</a></li>
      <li><a href="http://localhost:1313/ally-petitt/tags/informative/">Informative</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/ally-petitt/">Ally Petitt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
